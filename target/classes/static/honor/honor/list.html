<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>荣誉资质管理系统</title>

    <link rel="shortcut icon" href="favicon.ico"> <link href="/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/css/font-awesome.min.css?v=4.4.0" rel="stylesheet">

    <!-- Data Tables -->
    <link href="/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">

    <link href="/css/animate.min.css" rel="stylesheet">
    <link href="/css/style.min.css?v=4.1.0" rel="stylesheet">
    <link href="/css/plugins/layui/css/layui.css?v=4.1.0" rel="stylesheet">
    <style>
        .bootstrap-table .fixed-table-container .fixed-table-body {
            overflow-x: unset;
            overflow-y: unset;
            height: 100%;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">

        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div class="row row-lg">
                    <div class="col-sm-12">
                        <div class="example">
                            <div class="btn-group  form-horizontal">
                                <div class="col-sm-12">
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">资源全称：</span>
                                            <input id="search-honorName" type="text" placeholder="检索全称/别名" class="form-control">
                                        </div>
                                    </div>
                                    <!--<div class="col-sm-3">-->
                                        <!--<div class="input-group m-b">-->
                                            <!--<span class="input-group-addon">荣誉类型：</span>-->
                                            <!--<select class="form-control m-b" id="search-honorType">-->
                                                <!--<option value="">全部</option>-->
                                                <!--<option value="企业">企业</option>-->
                                                <!--<option value="个人">个人</option>-->
                                            <!--</select>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">资源分类：</span>
                                            <input class="form-control m-b" id="search-honorCategory"/>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">所属单位/个人：</span>
                                            <select class="form-control m-b" id="search-honorOrganization">
                                                <option value="">全部</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">区域级别：</span>
                                            <select class="form-control m-b" id="search-honorLevel">
                                                <option value="">全部</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            <!--</div>-->
                            <!--<div class="btn-group  form-horizontal">-->
                                <div class="col-sm-12">

                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">重要程度：</span>
                                            <select class="form-control m-b" id="search-honorGrade">
                                                <option value="">全部</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">获取时间：</span>
                                            <input id="search-getDate" readonly type="text" placeholder="选择年份" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">状态：</span>
                                            <select class="form-control m-b" id="search-status">
                                                <option value="">全部</option>
                                                <option value="有效">有效</option>
                                                <option value="即将到期">即将到期</option>
                                                <option value="已失效">已失效</option>
                                                <option value="已作废">已作废</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">申请人：</span>
                                            <input id="search-applicant" type="text" placeholder="" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            <!--</div>-->
                            <!--<div class="btn-group  form-horizontal">-->
                                <div class="col-sm-12">

                                    <div class="col-sm-3">
                                        <div class="input-group m-b">
                                            <span class="input-group-addon">维护人：</span>
                                            <input id="search-maintainer" type="text" placeholder="" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-3" id="search-div">
                                        <a onclick="searchTable()" class="btn btn-success col-sm-5" style="margin-right: 10px;">搜索</a>
                                        <a onclick="reset()" class="btn btn-default col-sm-5">重置</a>
                                    </div>
                                </div>
                                <div class="col-sm-12">
                                    <div class="col-sm-1">
                                        <div class="input-group m-b" id="add-div">
                                            <a onclick="openPage(0);" class="btn btn-success ">新增资源</a>
                                        </div>
                                    </div>
                                    <div class="col-sm-10"></div>
                                    <div class="col-sm-1">
                                        <div class="input-group m-b">
                                            <a onclick="exportExcel('新增荣誉资质');" class="btn btn-success ">导出列表</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="/*overflow: auto;height: 500px; */">
                                <table id="tableFromData" data-mobile-responsive="true">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Panel Basic -->
    </div>
<!--    <div class="modal-backdrop in" id="mask-div" onclick="hideModal()"></div>-->
    <script src="/js/jquery.min.js?v=2.1.4"></script>
    <script src="/js/common.js"></script>
    <script src="/js/bootstrap.min.js?v=3.3.6"></script>
    <script src="/js/content.min.js?v=1.0.0"></script>
    <script src="/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <!--<script src="/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>-->
    <script src="/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<!--    <script type="text/javascript" src="/js/plugins/layer-v3.5.1/layer/layer.js"></script>-->
    <script type="text/javascript" src="/css/plugins/layui/layui.js"></script>
    <script src="/js/plugins/cascader/cascader.js?css=true"></script>
    <script>
        var btn_permiss = localStorage.getItem("honor-btn");
        if(btn_permiss&&btn_permiss.indexOf('honor:add')>-1){
            $('#add-div').show();
        }else{
            $('#add-div').hide();
        }
        function openPage(id,uuid){
            if(!uuid){
                $.ajax({
                    url: "/dict/getUuid",
                    method: "get",
                    async: false,   //是否支持异步刷新，默认是true
                    success: function (data){
                        if(data.code==200&&data.result) {
                            layer.open({
                                type: 2,
                                offset: 'rt',
                                title: '新增资源',
                                // anim 特效 0-平滑放大 1-从上掉落 2-从底部往上滑入 3-从左滑入 4-从左翻转 5-渐显 6-抖动
                                anim: 0,
                                area: ['100%', '100%'], //宽高
                                content: './edit.html?id='+id+'&uuid='+data.result,
                                cancel: function(index, layero){

                                }
                            });
                        }
                    }
                })
            }else{
                layer.open({
                    type: 2,
                    offset: 'rt',
                    title: '编辑资源',
                    // anim 特效 0-平滑放大 1-从上掉落 2-从底部往上滑入 3-从左滑入 4-从左翻转 5-渐显 6-抖动
                    anim: 0,
                    area: ['100%', '100%'], //宽高
                    content: './edit.html?id='+id+'&uuid='+uuid,
                    cancel: function(index, layero){

                }
                });
            }

        }

        layui.use('laydate', function(){
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#search-getDate' //指定元素
                ,type:'year'
            });
        });

        function reset(){
            $('#search-honorName').val('');
            $('#search-honorType').val('');
            // $('#search-honorCategory').val('');
            $('#search-honorOrganization').val('');
            $('#search-honorLevel').val('');
            $('#search-honorGrade').val('');
            $('#search-getDate').val('');
            $('#search-status').val('');
            $('#search-applicant').val('');
            $('#search-maintainer').val('');
            honorCategoryCascader.setValue('');
            searchTable();
        }
        function searchTable(){
            $("#tableFromData").bootstrapTable('refreshOptions',{pageNumber:1});
            var honorName = $('#search-honorName').val();
            var honorType = $('#search-honorType').val();
            var honorCategory = $('#search-honorCategory').val();
            var honorOrganization = $('#search-honorOrganization').val();
            var honorLevel = $('#search-honorLevel').val();
            var honorGrade = $('#search-honorGrade').val();
            var getDate = $('#search-getDate').val();
            var statusName = $('#search-status').val();
            var applicant = $('#search-applicant').val();
            var maintainer = $('#search-maintainer').val();
            $('#tableFromData').bootstrapTable('refresh',{query:{honorName:honorName,honorType:honorType,categoryId:honorCategory,
                    statusStr:statusName,honorOrganization:honorOrganization,honorLevel:honorLevel,honorGrade:honorGrade,getDateStr:getDate,
                    applicant:applicant,maintainer:maintainer}});
        }
        if(btn_permiss&&btn_permiss.indexOf('honor:list')>-1){
            loadDataTable();
            $('#search-div').show()
        }else{
            $('#search-div').hide()
        }
        function loadDataTable(){
            $("#tableFromData").bootstrapTable({
                url: '/honorManage?sortField=modifyTime&sortOrder=descend',
                method: 'get',
                dataType: 'json',
                search: false,
                pagination: true,
                sidePagination:'server',//指定服务器端分页
                pageSize:10,//单页记录数
                pageList:[10,20,30,40],//分页步进值
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                iconSize: "outline",
                queryParams:function(params){
                    var honorName = $('#search-honorName').val();
                    var honorType = $('#search-honorType').val();
                    var honorCategory = $('#search-honorCategory').val();
                    var honorOrganization = $('#search-honorOrganization').val();
                    var honorLevel = $('#search-honorLevel').val();
                    var honorGrade = $('#search-honorGrade').val();
                    var getDate = $('#search-getDate').val();
                    var statusName = $('#search-status').val();
                    var applicant = $('#search-applicant').val();
                    var maintainer = $('#search-maintainer').val();
                    params.honorName = honorName;
                    params.honorType = honorType;
                    params.categoryId = honorCategory;
                    params.statusStr = statusName;
                    params.honorOrganization = honorOrganization;
                    params.honorLevel = honorLevel;
                    params.honorGrade = honorGrade;
                    params.getDateStr = getDate;
                    params.applicant = applicant;
                    params.maintainer = maintainer;
                    return params;
                },
                // toolbar: "#tableFromDataToolbar",
                icons: {
                    refresh: "glyphicon-repeat",
                    toggle: "glyphicon-list-alt",
                    columns: "glyphicon-list"
                },
                columns: [{
                    field: 'honorCategory',
                    title: '资源分类',
                    align: 'center'
                },{
                    field: 'honorOrganization',
                    title: '所属单位/个人',
                    align: 'center'
                },{
                    field: 'serialNumber',
                    title: '编号',
                    align: 'center'
                },{
                    field: 'honorName',
                    title: '资源全称',
                    align: 'center'
                },{
                    field: 'honorAlias',
                    title: '资源别名/简称',
                    align: 'center'
                },{
                    field: 'honorLevel',
                    title: '区域级别',
                    align: 'center'
                },{
                    field: 'honorGrade',
                    title: '重要程度',
                    align: 'center'
                },{
                    field: 'getDate',
                    title: '&nbsp;&nbsp;&nbsp;获取时间&nbsp;&nbsp;&nbsp;',
                    align: 'center'
                },{
                    field: 'expireDate',
                    title: '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp到期时间&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                    align: 'center',
                    width:180,
                    formatter:function(value,row,index){
                        if(row.validStatus==1){
                            value = "长期有效";
                        }
                        return value;
                    }
                },{
                    field: 'auditDate',
                    title: '下一次复评时间',
                    align: 'center'
                },{
                    field: 'maintainer',
                    title: '维护人',
                    align: 'center'
                },{
                    field: 'statusName',
                    title: '状态',
                    align: 'center',
                    formatter:function (value,row,index) {
                        var statusName;
                        if(value=='有效'){
                            statusName = '<span class="label label-info">'+value+'</span>';
                        }else if(value=='即将到期'){
                            statusName = '<span class="label label-warning">'+value+'</span>';
                        }else if(value=='已失效'){
                            statusName = '<span class="label label-danger">'+value+'</span>';
                        }else {
                            statusName = '<span class="label">'+value+'</span>';
                        }
                        return statusName;
                    }
                }, {
                    field: 'id',
                    title: '操作',
                    align: 'center',
                    formatter:function(value,row,index){
                        var editHtml = '';
                        var changeStatus = '';
                        if(btn_permiss&&btn_permiss.indexOf('honor:edit')>-1){
                            if(row.status==0){
                                editHtml ='<li><a onclick="openPage('+value+',\''+row.serialId+'\')" class="font-bold">编辑</a></li>';
                            }
                        }
                        if(btn_permiss&&btn_permiss.indexOf('honor:change')>-1){
                            if(row.status==0){
                                changeStatus = '<li><a onclick="changeStatus('+value+',-1)">作废</a></li>';
                            }else {
                                changeStatus = '<li><a onclick="changeStatus('+value+',0)">激活</a></li>';
                            }
                        }
                        var viewHtml = '';
                        if(btn_permiss&&btn_permiss.indexOf('honor:detail')>-1){
                            viewHtml = '<li><a onclick="view('+value+',\''+row.serialId+'\')" class="font-bold">查看</a></li>';
                        }
                        var delHtml = '';
                        if(btn_permiss&&btn_permiss.indexOf('honor:del')>-1){
                            delHtml = '<li class="divider"></li><li><a onclick="del('+value+')">删除</a></li>';
                        }
                        var htm = '<div class="btn-group">\n' +
                            '                                <button data-toggle="dropdown" class="btn btn-primary btn-sm dropdown-toggle" aria-expanded="false">操作 <span class="caret"></span>\n' +
                            '                                </button>\n' +
                            '                                <ul class="dropdown-menu">\n' +
                            viewHtml + editHtml + changeStatus + delHtml +
                            '                                </ul>\n' +
                            '                            </div>';
                        return htm;
                    }
                }]
            })
        }
        function changeStatus(id, status) {
            var text = '作废';
            if(status==0){
                text = '激活';
            }
            layer.confirm('是否'+text+'该条记录？', {
                btn: [text,'取消'] //按钮
            }, function(){
                changeStatusRecord(id, status);
            }, function(){
                layer.msg('已取消', {icon: 1});
            });
        }

        function changeStatusRecord(id,status) {
            $.ajax({
                url:"/honorManage/changeStatus/"+id,
                type:"PUT",
                data:{status:status},
                success:function (result) {
                    if(result.code==200){
                        layer.msg('操作成功', {icon: 1});
                        $('#tableFromData').bootstrapTable('refresh');
                    }else{
                        alert("操作失败，失败原因："+result.message);
                    }
                }
            });
        }

        function del(id) {
            layer.confirm('是否删除该条记录？', {
                btn: ['删除','取消'] //按钮
            }, function(){
                delRecord(id);
            }, function(){
                layer.msg('已取消', {icon: 1});
            });
        }
        function delRecord(id){
            $.ajax({
                url:"/honorManage/"+id,
                type:"DELETE",
                success:function (result) {
                    if(result.code==200){
                        layer.msg('删除成功', {icon: 1});
                        $('#tableFromData').bootstrapTable('refresh');
                    }else{
                        alert("删除失败，失败原因："+result.message);
                    }
                }
            });
        }
        
        function view(id,uuid) {
            layer.open({
                type: 2,
                offset: 'rt',
                title: '资源详情',
                // anim 特效 0-平滑放大 1-从上掉落 2-从底部往上滑入 3-从左滑入 4-从左翻转 5-渐显 6-抖动
                anim: 2,
                area: ['85%', '100%'], //宽高
                content: './view.html?id='+id+'&uuid='+uuid
            });
        }


        var honorCategoryCascader;
        loadCategory()
        function loadCategory() {
            $.ajax({
                url:"/category/listForSelect",
                type:"GET",
                async : false,
                success:function (result) {
                    if(result.code==200){
                        layui.use('layCascader', function () {
                            var layCascader = layui.layCascader;
                            honorCategoryCascader = layCascader({
                                elem: '#search-honorCategory',
                                options: result.result,
                                props: {
                                    expandTrigger: 'hover',
                                    checkStrictly: true
                                }
                            });
                        });
                    }
                }
            });
        }
        loadDict('honorOrganization','search-honorOrganization');
        loadDict('honorLevel','search-honorLevel');
        loadDict('honorGrade','search-honorGrade');
        function loadDict(fieldKey,id) {
            $.ajax({
                url:"/dict/listForSelect",
                type:"GET",
                data:{fieldKey:fieldKey},
                success:function (result) {
                    if(result.code==200){
                        result.result.forEach(item => {
                            var option = '<option value="'+item.name+'">'+item.name+'</option>';
                        $('#'+id).append(option);
                    })

                    }
                }
            });
        }

        function exportExcel() {
            var url = '/honorManage/export?';
            var honorName = $('#search-honorName').val();
            var honorCategory = $('#search-honorCategory').val();
            var honorOrganization = $('#search-honorOrganization').val();
            var honorLevel = $('#search-honorLevel').val();
            var honorGrade = $('#search-honorGrade').val();
            var getDate = $('#search-getDate').val();
            var status = $('#search-status').val();
            var applicant = $('#search-applicant').val();
            var maintainer = $('#search-maintainer').val();
            url+="&honorName="+honorName+"&honorCategory="+honorCategory+"&honorOrganization="+honorOrganization
                +"&honorLevel="+honorLevel+"&honorGrade="+honorGrade+"&getDate="+getDate+"&status="+status+"&applicant="+applicant+"&maintainer="+maintainer;
            window.location.href=url;

        }

    </script>

</body>
</html>
